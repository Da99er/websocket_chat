<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>

<body>
    <script>
    var chat_socket = new WebSocket("ws://127.0.0.1:8081", "test123");

    function _creat_chat_template(msg) {
        var chat_form = document.createElement("form");
        chat_form.name = msg.id;
        var chat_input_message = document.createElement("textarea");
        chat_input_message.name = "chat_message";
        var chat_send_message = document.createElement("input");
        chat_send_message.value = "send";
        chat_send_message.type = "submit";
        var chat_conersation = document.createElement("div");
        chat_conersation.id = msg.id;
        chat_form.appendChild(chat_conersation);
        chat_form.appendChild(chat_input_message);
        chat_form.appendChild(chat_send_message);
        document.body.appendChild(chat_form);

        _add_msg(msg);
        chat_form.onsubmit = function() {
            var message = this.chat_message.value;
            this.chat_message.value = "";
            var id = this.name;
            message && chat_socket.send(JSON.stringify({
                message: message,
                id: id
            }));
            return false;
        };
    }

    chat_socket.onmessage = function(event) {
        var msg = JSON.parse(event.data);

        if (document.getElementById(msg.id)) {
            _add_msg(msg);
        } else {
            _creat_chat_template(msg);
        }

        if (msg && msg.message === "/close" && document.getElementsByName(msg.id)[0]) {
            document.getElementsByName(msg.id)[0].remove();
        }
    };

    function _add_msg(msg) {
        var messageElem = document.createElement('div');
        let message_text = (msg.is_admin ? "you" : msg.id) + " : " + msg.message;
        messageElem.appendChild(document.createTextNode(message_text));
        document.getElementById(msg.id).appendChild(messageElem);
    }
    </script>
    <style>
    form {
        display: inline-block;
        width: 20%;
        min-width: 250px;
        font-size: 12px;
    }
    </style>
</body>

</html>
